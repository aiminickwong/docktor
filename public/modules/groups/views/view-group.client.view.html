<section data-ng-controller="GroupsController" data-ng-init="findOne()">

    <div layout="row" layout-align="center center">
        <h3 flex>
            <md-button class="md-accent" href="#!/groups">My Groups</md-button>
            / {{group.title}}
        </h3>
        <span flex></span>

        <div ng-show="authentication.isAdmin" flex>
            <md-button class="md-raised md-primary" href="/#!/admin/groups/{{group._id}}/deploy/service">
                <i class="fa fa-plus"> </i> Deploy a service
            </md-button>
            <md-button class="md-raised" href="/#!/admin/groups/{{group._id}}/edit">
                <i class="fa fa-edit"> </i> Edit this group
            </md-button>
        </div>
    </div>

    <p data-ng-bind="group.description"></p>

    <div class="row">
        <h4><i class="fa fa-users"></i> Contacts</h4>
        <span ng-repeat="u in group.users">
            <md-button class="md-accent" href="mailto:{{u.email}}">
                <i class="fa fa-envelope"></i> {{u.displayName}}
            </md-button>
        </span>

        <div>
            <md-button class="md-accent" href="mailto:{{group.mailAllUsers}}">
                <i class="fa fa-envelope"></i> Mail All
            </md-button>
        </div>
    </div>

    <div class="row">
        <h4><i class="fa fa-tachometer"></i> Monitoring</h4>

        <div ng-hide="group.filesystems" class="alert alert-danger">
            No filesystem attached to this group.
            <span ng-show="authentication.isAdmin">Try to add one by
                <md-button class="md-accent" href="#!/admin/groups/{{group._id}}/edit">editing this group</md-button>.
            </span>
            <span ng-hide="authentication.isAdmin">Ask the Administrators.</span>
        </div>

        <div ng-repeat="fs in group.filesystems" layout="row">
            <div flex>
                <div class="progress">
                    <div class="progress-bar progress-bar-danger" role="progressbar"
                         aria-valuenow="{{fs.statsCompute.usage}}" aria-valuemin="0"
                         aria-valuemax="{{fs.statsCompute.capacity}}"
                         style="width: {{fs.statsCompute.usagePercent}}%;">
                        <span>&nbsp;</span>
                    </div>
                </div>
            </div>

            <div flex>
                <div><i class="fa fa-pie-chart"></i>
                    {{fs.partition}} : {{fs.statsCompute.usageInMB}} Gb / {{fs.statsCompute.capacityInMB}} Gb
                    ({{fs.statsCompute.usagePercent}}%)
                </div>
                <div><i>{{fs.description}}</i></div>
            </div>
        </div>
        <div class="row">
            <i class="fa fa-bar-chart"></i>
            <md-button class="md-accent" href="{{grafanaUrl}}?groupName={{group.title}}">
                Monitoring CPU / RAM - All Services
            </md-button>
        </div>
    </div>
    <div class="row">
        <h4><i class="fa fa-cloud"></i> Services</h4>

        <div ng-show="group.containers.length === 0">
            No service deployed for this group.
        </div>
    </div>

    <table ng-show="group.containers.length > 0" tr-ng-grid="" items="group.containers" fields="" class="table">
        <thead>
        <tr>
            <th field-name="serviceTitle" display-name="Service" enable-filtering="true"></th>
            <th field-name="name" display-name="Container - Image" enable-filtering="true"></th>
            <th>
                <div class="tr-ng-title">
                    Status
                </div>
            </th>
            <th>
                <div class="tr-ng-title">
                    Commands
                </div>
            </th>
            <th>
                <div class="tr-ng-title">
                    Daemon
                </div>
            </th>
            <th>
                <div class="tr-ng-title">
                    Monitoring
                </div>
            </th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td field-name="serviceTitle">
                <md-button class="md-accent" href="#!/groups/{{group._id}}/{{gridItem._id}}">
                    <span ng-hide="gridItem.serviceTitle">Need Redeploy to <br>have a name here</span>
                    {{gridItem.serviceTitle}}
                </md-button>

                <div>
                <span ng-repeat="url in gridItem.urls">
                    <md-button class="md-accent" href={{url.urlCompute}}>
                        <i class="fa fa-link"></i> {{url.label}}
                    </md-button>
                </span>
                </div>
            </td>
            <td field-name="name">
                <div>
                    {{gridItem.name}}<br>
                    <small>{{gridItem.image}}</small>
                    <br>
                    <small>{{gridItem.containerId | limitTo:12}}</small>
                </div>
            </td>
            <td>
                <div ng-switch="gridItem.daemon.dockerStatus">

                    <div ng-switch-when="checking">
                    </div>
                    <div ng-switch-when="down">
                        Down <br>
                        <small>Daemon Down</small>
                    </div>

                    <div ng-switch-when="up">
                        <md-subheader ng-show="gridItem.inspect.State.Running" class="md-primary">
                            Running
                        </md-subheader>
                        <md-subheader ng-hide="gridItem.inspect.State.Running" class="md-warn">
                            Stopped
                        </md-subheader>
                        <md-subheader ng-show="gridItem.inspect.State.Paused" class="md-accent">
                            Paused
                        </md-subheader>
                    </div>
                </div>
            </td>
            <td>
                <div ng-switch="gridItem.daemon.dockerStatus">

                    <div ng-switch-when="checking">
                    </div>
                    <div ng-switch-when="down">
                        No Command <br>
                        <small>Daemon Down</small>
                    </div>

                    <div ng-switch-when="up">
                        <md-button ng-hide="gridItem.containerId" class="md-raised md-primary"
                                   ng-click="createContainer(gridItem)"><i class="fa fa-cogs"></i> Docker create
                        </md-button>

                        <span ng-show="gridItem.containerId">

                            <span ng-hide="gridItem.inspect.State.Running" class="btn btn-xs btn-primary btn-sm"
                                  ng-click="startContainer(gridItem)">
                                <i class="fa fa-play"></i> Docker run
                            </span>

                            <span ng-show="gridItem.inspect.State.Running">

                                <div class="btn-group" dropdown is-open="status.isopen">
                                    <md-button class="md-raised md-primary" dropdown-toggle
                                               ng-disabled="disabled">
                                        Action... <span class="caret"></span>
                                    </md-button>
                                    <ul class="dropdown-menu" role="menu">
                                        <li><a href="" ng-hide="gridItem.inspect.State.Paused"
                                               ng-click="stopContainer(gridItem)">
                                            <i class="fa fa-stop"></i> Docker stop
                                        </a></li>
                                        <li><a href="" ng-hide="gridItem.inspect.State.Paused"
                                               ng-click="pauseContainer(gridItem)"><i class="fa fa-pause"></i> Docker
                                            pause
                                        </a></li>
                                        <li><a href="" ng-show="gridItem.inspect.State.Paused"
                                               ng-click="unpauseContainer(gridItem)"><i class="fa fa-pause"></i> Docker
                                            unpause
                                        </a></li>
                                        <li><a href="" ng-click="killContainer(gridItem)"><i
                                                class="fa fa-crosshairs"></i> Docker kill
                                        </a></li>
                                    </ul>
                                </div>
                            </span>

                            <md-button ng-hide="gridItem.inspect.State.Running" class="md-raised md-warn"
                                       ng-click="removeContainer(gridItem)"><i class="fa fa-trash"></i> Docker remove
                            </md-button>
                        </span>
                    </div>
                </div>
            </td>
            <td>
                <div ng-switch="gridItem.daemon.dockerStatus">
                    <span ng-switch-when="checking" class="label label-default" layout="row"
                          layout-align="center center">
                        <md-progress-circular class="md-accent md-hue-1" md-diameter="24" md-mode="indeterminate">
                        </md-progress-circular>
                        <md-button class="md-warn" ng-show="authentication.isAdmin"
                                   href="#!/admin/daemons/view/{{gridItem.daemonId}}" layout="row">
                            <small>{{gridItem.daemon.name}} <br>checking...</small>
                        </md-button>

                        <span ng-hide="authentication.isAdmin">{{gridItem.daemon.name}} checking...</span>
                    </span>
                    <span ng-switch-when="down">
                        <md-button class="md-warn" ng-show="authentication.isAdmin"
                                   href="#!/admin/daemons/view/{{gridItem.daemonId}}">
                            {{gridItem.daemon.name}} {{gridItem.daemon.dockerStatus}}
                        </md-button>
                        <span ng-hide="authentication.isAdmin" class="label label-danger">
                            {{gridItem.daemon.name}} {{gridItem.daemon.dockerStatus}}
                        </span>
                    </span>

                    <div ng-switch-when="up">
                        <md-button class="md-accent md-raised md-hue-3" ng-show="authentication.isAdmin"
                                   href="#!/admin/daemons/view/{{gridItem.daemonId}}">
                            {{gridItem.daemon.name}} {{gridItem.daemon.dockerStatus}}
                        </md-button>
                        <span ng-hide="authentication.isAdmin" class="label label-success">
                                {{gridItem.daemon.name}} {{gridItem.daemon.dockerStatus}}
                        </span>
                    </div>
                </div>
            </td>
            <td>
                <div layout-align="center">
                    <md-button class="md-fab"
                               href="{{grafanaUrl}}?groupName={{group.title}}&containerName={{gridItem.name}}">
                        <i class="fa fa-bar-chart"></i>
                    </md-button>
                </div>
            </td>
        </tr>
        </tbody>
    </table>
</section>
